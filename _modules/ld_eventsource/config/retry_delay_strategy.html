

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>ld_eventsource.config.retry_delay_strategy &mdash; launchdarkly-eventsource 1.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> launchdarkly-eventsource
          

          
          </a>

          
            
            
              <div class="version">
                1.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"></div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">launchdarkly-eventsource</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>ld_eventsource.config.retry_delay_strategy</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ld_eventsource.config.retry_delay_strategy</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">Random</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span>


<div class="viewcode-block" id="RetryDelayStrategy"><a class="viewcode-back" href="../../../index.html#ld_eventsource.config.RetryDelayStrategy">[docs]</a><span class="k">class</span> <span class="nc">RetryDelayStrategy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class of strategies for computing how long to wait before retrying a connection.</span>
<span class="sd">    </span>
<span class="sd">    The default behavior, provided by :meth:`default()`, provides customizable exponential backoff</span>
<span class="sd">    and jitter. Applications may also create their own subclasses of RetryDelayStrategy if they</span>
<span class="sd">    desire different behavior. It is generally a best practice to use backoff and jitter, to avoid</span>
<span class="sd">    a reconnect storm during a service interruption.</span>

<span class="sd">    Subclasses should be immutable. To implement strategies where the delay uses different parameters</span>
<span class="sd">    on each subsequent retry (such as exponential backoff), the strategy should return a new instance</span>
<span class="sd">    of its own class as the second return value from ``apply``, rather than modifying the state of</span>
<span class="sd">    the existing instance. This makes it easy for SSEClient to reset to the original delay state when</span>
<span class="sd">    appropriate by simply reusing the original instance.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RetryDelayStrategy.apply"><a class="viewcode-back" href="../../../index.html#ld_eventsource.config.RetryDelayStrategy.apply">[docs]</a>    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_delay</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">RetryDelayStrategy</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Applies the strategy to compute the appropriate retry delay.</span>

<span class="sd">        :param base_delay: the initial configured base delay, in seconds, as set in the SSEClient</span>
<span class="sd">            parameters</span>
<span class="sd">        :return: a tuple where the first element is the computed delay, in seconds, and the second</span>
<span class="sd">            element the strategy object to use next time (which could be ``self``)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">base_delay</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>

<div class="viewcode-block" id="RetryDelayStrategy.default"><a class="viewcode-back" href="../../../index.html#ld_eventsource.config.RetryDelayStrategy.default">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">default</span><span class="p">(</span>
        <span class="n">max_delay</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">backoff_multiplier</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="n">jitter_multiplier</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RetryDelayStrategy</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Provides the default retry delay behavior for :class:`.SSEClient`, which includes</span>
<span class="sd">        customizable backoff and jitter options.</span>

<span class="sd">        The behavior is as follows:</span>

<span class="sd">        * Start with the configured base delay as set by the ``initial_retry_delay`` parameter to</span>
<span class="sd">          :class:`.SSEClient`.</span>
<span class="sd">        * On each subsequent attempt, multiply the base delay by ``backoff_multiplier``, giving the</span>
<span class="sd">          current base delay.</span>
<span class="sd">        * If ``max_delay`` is set and is greater than zero, the base delay is pinned to be no greater</span>
<span class="sd">          than that value.</span>
<span class="sd">        * If ``jitter_multiplier`` is set and is greater than zero, the actual delay for each attempt is</span>
<span class="sd">          equal to the current base delay minus a pseudo-random number equal to that ratio times itself.</span>
<span class="sd">          For instance, a jitter multiplier of 0.25 would mean that a base delay of 1000 is changed to a</span>
<span class="sd">          value in the range [750, 1000].</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        :param max_delay: the maximum possible delay value, in seconds; default is 30 seconds</span>
<span class="sd">        :param backoff_multiplier: the exponential backoff factor</span>
<span class="sd">        :param jitter_multiplier: a fraction from 0.0 to 1.0 for how much of the delay may be</span>
<span class="sd">        pseudo-randomly subtracted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_DefaultRetryDelayStrategy</span><span class="p">(</span><span class="n">max_delay</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span> <span class="n">backoff_multiplier</span><span class="p">,</span> <span class="n">jitter_multiplier</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span>
            <span class="mi">0</span><span class="p">,</span> <span class="n">_ReusableRandom</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span></div>

<div class="viewcode-block" id="RetryDelayStrategy.from_lambda"><a class="viewcode-back" href="../../../index.html#ld_eventsource.config.RetryDelayStrategy.from_lambda">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">from_lambda</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RetryDelayStrategy</span><span class="p">]]])</span> <span class="o">-&gt;</span> <span class="n">RetryDelayStrategy</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convenience method for creating a RetryDelayStrategy whose ``apply`` method is equivalent to</span>
<span class="sd">        the given lambda.</span>
<span class="sd">        </span>
<span class="sd">        The one difference is that the second return value is an ``Optional[RetryDelayStrategy]`` which</span>
<span class="sd">        can be None to mean &quot;no change&quot;, since the lambda cannot reference the strategy&#39;s ``self``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_LambdaRetryDelayStrategy</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">_DefaultRetryDelayStrategy</span><span class="p">(</span><span class="n">RetryDelayStrategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">max_delay</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">backoff_multiplier</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">jitter_multiplier</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">last_base_delay</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">random</span><span class="p">:</span> <span class="n">_ReusableRandom</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__max_delay</span> <span class="o">=</span> <span class="n">max_delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__backoff_multiplier</span> <span class="o">=</span> <span class="n">backoff_multiplier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__jitter_multiplier</span> <span class="o">=</span> <span class="n">jitter_multiplier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__last_base_delay</span> <span class="o">=</span> <span class="n">last_base_delay</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__random</span> <span class="o">=</span> <span class="n">random</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_delay</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">RetryDelayStrategy</span><span class="p">]:</span>
        <span class="n">next_base_delay</span> <span class="o">=</span> <span class="n">base_delay</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__last_base_delay</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">__last_base_delay</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">__backoff_multiplier</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__max_delay</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">next_base_delay</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">__max_delay</span><span class="p">:</span>
            <span class="n">next_base_delay</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__max_delay</span>
        <span class="n">adjusted_delay</span> <span class="o">=</span> <span class="n">next_base_delay</span>

        <span class="n">random</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__random</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__jitter_multiplier</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># To avoid having this object contain mutable state, we create a new Random with the same</span>
            <span class="c1"># state as our previous Random before using it.</span>
            <span class="n">random</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
            <span class="n">adjusted_delay</span> <span class="o">-=</span> <span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">__jitter_multiplier</span> <span class="o">*</span> <span class="n">adjusted_delay</span><span class="p">)</span>
        
        <span class="n">next_strategy</span> <span class="o">=</span> <span class="n">_DefaultRetryDelayStrategy</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__max_delay</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__backoff_multiplier</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__jitter_multiplier</span><span class="p">,</span>
            <span class="n">next_base_delay</span><span class="p">,</span>
            <span class="n">random</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">adjusted_delay</span><span class="p">,</span> <span class="n">next_strategy</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_LambdaRetryDelayStrategy</span><span class="p">(</span><span class="n">RetryDelayStrategy</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">float</span><span class="p">],</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">Optional</span><span class="p">[</span><span class="n">RetryDelayStrategy</span><span class="p">]]]):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__fn</span> <span class="o">=</span> <span class="n">fn</span>
    
    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_delay</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">RetryDelayStrategy</span><span class="p">]:</span>
        <span class="n">delay</span><span class="p">,</span> <span class="n">maybe_next</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__fn</span><span class="p">(</span><span class="n">base_delay</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="n">maybe_next</span> <span class="ow">or</span> <span class="bp">self</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_ReusableRandom</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__random</span> <span class="o">=</span> <span class="n">Random</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">clone</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__random</span><span class="o">.</span><span class="n">getstate</span><span class="p">()</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">_ReusableRandom</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__seed</span><span class="p">)</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">__random</span><span class="o">.</span><span class="n">setstate</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;RetryDelayStrategy&#39;</span><span class="p">]</span>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2022, LaunchDarkly.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>